You are building prototype P4 (Fragment Workflow) for the Collage Earth project.

## Your Assignment

You are working on prototype P4 in the directory prototypes/p4-fragment/.
P4 validates the complete fragment workflow: extract a fragment (max 1 km¬≤) ‚Üí save to library ‚Üí navigate to destination ‚Üí cut hole and place fragment ‚Üí evaluate with network merge and isochrones. This is the flagship prototype that demonstrates Collage Earth's unique "urban collage" concept.

## Rules (critical)

1. ONLY modify files in prototypes/p4-fragment/. Never modify shared code, other prototypes, or root config.
2. FINDINGS.md is your primary output. Update it continuously as you work.
3. Commit frequently: proto(p4): description
4. Log all measurements (times, memory, FPS, success/failure rates) in FINDINGS.md.
5. If you observe any early failure indicator, stop, document it, and write your findings.
6. This is a prototype ‚Äî prioritize working features over polish. Skip extensive error handling.
7. Import shared components: `import { MapShell, useMapStore, BuildingMeshManager, colorize, extractArea } from '@collage/map-template';`
8. Import types: `import type { FragmentPackage, ... } from '@collage/proto-types';`
9. The Python backend runs at http://localhost:8000. The Vite proxy maps /api/* to the backend.

## Session Workflow

1. Check git log for prior work on this prototype
2. Read prototypes/p4-fragment/FINDINGS.md for current state
3. Continue from where you left off (or start Stage 1 if fresh)
4. Work through the stages in order (see brief below)
5. Update FINDINGS.md after each stage
6. At the end of each stage, write a **Manual Testing** checkpoint in FINDINGS.md (see below)
7. Commit and push when done or when stopping
8. When all stages are complete, change FINDINGS.md status to "Status: Complete"

## Manual Testing Checkpoints (critical)

The project owner is an architect, not a developer. After each stage:

1. **Commit your work** so the owner can test at any time.
2. **Add a "Manual Testing" section** under each stage in FINDINGS.md with:
   - Step-by-step instructions (assume no command-line knowledge)
   - What to look for and what "good" vs "bad" looks like
3. **Mark each checkpoint** with one of:
   - `üîç Awaiting human verification` ‚Äî owner hasn't tested yet
   - `‚úÖ Human-verified` ‚Äî owner confirmed it works
   - `‚ö†Ô∏è Human-verified with issues` ‚Äî owner found problems
4. **Do NOT wait for testing.** Continue to the next stage immediately.

## Prototype Brief

### Question
Can a complete urban fragment workflow ‚Äî extract, save, relocate, place with context clipping, evaluate with network merge and isochrones ‚Äî be implemented as an interactive web application?

### Success Criteria

1. Extract ‚Üí Save ‚Üí Load round-trip preserves all building geometry, heights, and metrics
2. Fragment library stores 3+ fragments from different cities (Barcelona, Prague, Amsterdam)
3. Fragment relocation completes in <5s (CRS reassignment, coordinate transform)
4. Hard clip removes all context buildings inside fragment boundary
5. Network merge produces a connected graph (no isolated components at junction)
6. Isochrone after placement extends beyond fragment boundary (proves connectivity)
7. Radar chart shows morphological differences between fragment and context
8. 3D rendering distinguishes fragment (orange #FF6B35) from context (grey #9CA3AF)
9. Fragment card shows: name, city, building count, GSI, FSI, L, LCZ badge
10. Full workflow from first click to evaluation completes in <5 minutes
11. Fragment boundary visualization shows clear perimeter during placement
12. Network merge quality panel shows snap distance and connection count

### Failure Indicators (stop early)

- Fragment relocation completely fails (coordinate transform produces NaN or wrong hemisphere)
- Network merge produces >50% isolated edges
- Backend /fragment/save or /fragment/load endpoints return errors

### Stages

**Stage 1: Extract Fragment** ‚Äî User draws rectangle (max 1 km¬≤) on map. Call backend /extract ‚Üí /heights ‚Üí /tessellate ‚Üí /metrics/momepy ‚Üí /metrics/sustainability ‚Üí /space-syntax (pipeline). Display extracted buildings in 3D. Show extraction progress. This reuses the shared MapShell area selector. Package the result as a FragmentPackage (buildings, streets, enclosures, tessellation, metrics, metadata).

**Stage 2: Save to Library** ‚Äî Implement fragment library sidebar (left panel, 300px). Add "Save Fragment" button that calls backend /fragment/save (serializes to GeoParquet). Show fragment card with: name (editable), city, building count, area, GSI, FSI, L, LCZ badge, small thumbnail (canvas snapshot). Implement /fragment/load to restore from saved. Library persists fragments in browser localStorage (just metadata + backend file reference).

**Stage 3: Navigate to Destination** ‚Äî User can pan/fly the map to a new city. This is free navigation ‚Äî no special code needed beyond MapShell's built-in controls. Add "quick fly" buttons for preset cities: Barcelona, Prague, Amsterdam, London, San Francisco. When user clicks a library fragment card, enable "Place" mode.

**Stage 4: Cut Hole and Place Fragment** ‚Äî When "Place" mode is active: (1) user clicks a destination point on the map, (2) call backend /extract for context around destination, (3) call backend /fragment/relocate to transform fragment to destination CRS, (4) render both fragment and context buildings in 3D ‚Äî fragment in orange (#FF6B35), context in grey (#9CA3AF), (5) hard clip: remove all context buildings that intersect the fragment boundary. Show fragment boundary as a highlighted polygon outline.

**Stage 5: Evaluate ‚Äî Network Merge and Isochrones** ‚Äî Call backend /network/merge to connect fragment streets with context streets (edge-split merge). Show merge quality: connection count, mean snap distance, status badge (green/yellow/red). Call backend /network/isochrone for a point inside the fragment ‚Äî display 3 walking isochrone polygons (5/10/15 min). Show that isochrone extends beyond fragment boundary (proves network connectivity). Implement comparison panel: 8-axis radar chart comparing fragment vs context metrics (GSI, FSI, L, orientation, building area mean, height mean, meshedness, canyon H/W).

### Stack

MapLibre GL JS ^5.0.0, Three.js ^0.178.0, @dvt3d/maplibre-three-plugin ^1.3.0, React ^19.0.0, TypeScript ^5.9.0, Vite ^7.0.0, Zustand ^5.0.0, @turf/turf ^7.0.0.

### Backend Endpoints Used

1. `/extract` ‚Äî OSM extraction (~30-85s depending on area)
2. `/heights` ‚Äî Height cascade enrichment
3. `/tessellate` ‚Äî Enclosed tessellation
4. `/metrics/momepy` ‚Äî 61 morphological metrics
5. `/metrics/sustainability` ‚Äî Environmental metrics
6. `/space-syntax` ‚Äî NAIN/NACH (if cityseer available)
7. `/fragment/save` ‚Äî Serialize to GeoParquet (<1s)
8. `/fragment/load` ‚Äî Load from GeoParquet (<1s)
9. `/fragment/relocate` ‚Äî CRS reassignment relocation (~1.79s)
10. `/network/merge` ‚Äî Edge-split network merge (~0.5s)
11. `/network/isochrone` ‚Äî Walking isochrone (~0.02s)

### UI Layout

- **Map** fills viewport with 3D buildings (fragment orange, context grey)
- **Fragment library sidebar** (left, 300px): scrollable fragment cards
- **Fragment card**: name, city, building count, GSI/FSI/L, LCZ badge, [Fly To] [Place] [Delete] buttons
- **Quick fly bar** (top): Barcelona | Prague | Amsterdam | London | SF buttons
- **Extraction progress**: overlay showing pipeline stage + percentage
- **Placement mode overlay**: "Click to place fragment" message + fragment boundary preview
- **Merge quality panel** (bottom-right): connection count, snap distance, status badge
- **Comparison panel** (bottom, expandable): 8-axis radar chart + metric comparison table
- **Isochrone display**: 3 concentric fills (5min green, 10min yellow, 15min red)

### Research Context

Key planning documents in the research/ directory:
- research/87-plan-p4-fragment.md ‚Äî complete implementation plan
- research/findings-14-fragment-extraction.md ‚Äî fragment definition
- research/findings-15-fragment-comparison.md ‚Äî comparison methods
- research/findings-16-fragment-relocation.md ‚Äî relocation approach
- research/findings-17-fragment-collaging.md ‚Äî collage workflow

### Critical Notes

- Fragment relocation uses CRS reassignment (NOT reprojection) ‚Äî swap the CRS definition so coordinates map to new location
- Hard clip: use Shapely difference operation on backend, or Turf.js booleanDifference on client
- Network merge: edge-split approach ‚Äî find edges that cross the boundary, split them, snap endpoints
- The radar chart should normalize all 8 axes to 0‚Äì1 (divide by max across both areas)
- Fragment color #FF6B35 (warm orange), context #9CA3AF (cool grey)
- Isochrone: walking speed 80 m/min (4.8 km/h)
- GeoParquet files stored on backend in data/ directory
- Fragment metadata includes: name, source_city, bbox, crs, building_count, street_count, extraction_date
