You are building prototype P5 (Urban Taxonomy of San Francisco) for the Collage Earth project.

## Your Assignment

You are working on prototype P5 in the directory prototypes/p5-taxonomy/.
P5 validates the workflow: load pre-extracted citywide data for San Francisco â†’ render ~30Kâ€“50K tessellation cells at city scale â†’ visualize 3 classification systems (Spacematrix, LCZ, morphometric clustering) with bidirectional linked views between map, Spacematrix diagram, and dendrogram.

P5 is unique: it uses NO runtime backend calls. All data is pre-computed in a batch pipeline and bundled as GeoParquet files that load at startup.

## Rules (critical)

1. ONLY modify files in prototypes/p5-taxonomy/. Never modify shared code, other prototypes, or root config.
2. FINDINGS.md is your primary output. Update it continuously as you work.
3. Commit frequently: proto(p5): description
4. Log all measurements (times, memory, FPS, success/failure rates) in FINDINGS.md.
5. If you observe any early failure indicator, stop, document it, and write your findings.
6. This is a prototype â€” prioritize working features over polish. Skip extensive error handling.
7. Import shared components: `import { MapShell, useMapStore } from '@collage/map-template';`
8. Import types: `import type { ... } from '@collage/proto-types';`
9. No backend API calls at runtime. Data comes from pre-built GeoParquet files.

## Automated Testing (critical)

Implement lightweight automated checks as you build each phase. NO browser automation.

### 1. window.__TEST_API__
The shared map template exposes `window.__TEST_API__` with scene state. Extend it in your prototype:

```javascript
(window).__TEST_API__ = {
  ...(window).__TEST_API__,
  getClassificationState: () => { /* return current classification system + cell counts */ },
};
```

After each phase, log a self-check:
```javascript
console.log('[P5-CHECK]', JSON.stringify(window.__TEST_API__.getClassificationState()));
```

### 2. Data pipeline validation
Since P5 uses pre-extracted data (no runtime backend), validate the batch pipeline output:
- Cell count: expect 30Kâ€“50K tessellation cells for San Francisco
- All 3 classification systems produce results (Spacematrix, LCZ, morphometric clusters)
- GeoParquet files load in <5s
Log results with `[P5-BENCHMARK]` prefix in FINDINGS.md.

### 3. Classification validation
Validate that classification patterns are geographically coherent:
- Spacematrix: downtown = high FSI, residential = low FSI
- LCZ: downtown â‰  residential areas
- Morphometric clusters: k â‰ˆ 8â€“12 (BIC-selected)
Log cluster counts and type distributions in FINDINGS.md.

### 4. No browser automation
Do NOT use Playwright, Puppeteer, or any browser automation tool. Do NOT take screenshots. Visual testing is manual after the autonomous run.

## Session Workflow

1. Check git log for prior work on this prototype
2. Read prototypes/p5-taxonomy/FINDINGS.md for current state
3. Continue from where you left off (or start Phase 1 if fresh)
4. Work through the phases in order (see brief below)
5. Update FINDINGS.md after each phase
6. At the end of each phase, write a **Manual Testing** checkpoint in FINDINGS.md (see below)
7. Commit and push when done or when stopping
8. When all phases are complete, change FINDINGS.md status to "Status: Complete"

## Manual Testing Checkpoints (critical)

The project owner is an architect, not a developer. After each phase:

1. **Commit your work** so the owner can test at any time.
2. **Add a "Manual Testing" section** under each phase in FINDINGS.md with:
   - Step-by-step instructions (assume no command-line knowledge)
   - What to look for and what "good" vs "bad" looks like
3. **Mark each checkpoint** with one of:
   - `ðŸ” Awaiting human verification` â€” owner hasn't tested yet
   - `âœ… Human-verified` â€” owner confirmed it works
   - `âš ï¸ Human-verified with issues` â€” owner found problems
4. **Do NOT wait for testing.** Continue to the next phase immediately.

## Prototype Brief

### Question
Can a city-scale urban taxonomy with 3 classification systems and ~30Kâ€“50K tessellation cells be rendered at â‰¥30 FPS with bidirectional linked views between a geographic map, Spacematrix scatter diagram, and hierarchical dendrogram?

### Success Criteria

1. City-scale rendering of SF tessellation cells â‰¥30 FPS (fill-extrusion or flat polygons)
2. Classification toggle (Spacematrix | LCZ | Cluster) switches cell colors in <500ms
3. Spacematrix diagram renders 30K dots at 60 FPS (Canvas 2D, not SVG)
4. Dendrogram renders all cluster hierarchy levels (D3.js tree layout)
5. Level-of-detail: z<15 shows flat tessellation cells, zâ‰¥15 fades in 3D buildings
6. Bidirectional selection: click cells on map â†’ highlight in diagram, click type in diagram â†’ highlight on map
7. Three classification systems show geographically coherent patterns (not random noise)
8. Cell hover tooltip shows: FSI, GSI, L, all 3 classification labels
9. Spacematrix diagram shows FSI/GSI axes with type zones labeled
10. Data loads from GeoParquet in <5s

### Failure Indicators (stop early)

- GeoParquet loading fails or takes >30s
- MapLibre cannot render 30K+ fill-extrusion polygons at >15 FPS
- D3 dendrogram crashes with 10+ cluster types

### Phases

**Phase 1: Data Pipeline + City-Scale Rendering** â€” First, create the batch data extraction pipeline (Python script, runs once). Download SF buildings (~80K) and streets (~15K) from OSM via OSMnx. Project to UTM 10N. Simplify streets with neatnet. Generate enclosed tessellation with momepy (â†’ ~30Kâ€“50K cells). Compute 74 primary momepy metrics per cell. Compute Spacematrix classification (FSI/GSI/L thresholds â†’ 8 types). Compute LCZ classification (BSF/BH/SVF/H_W/PSF â†’ 10 classes). Run GMM clustering (PCA â†’ 90% variance â†’ BIC-selected k â†’ 8â€“12 clusters). Build Ward's dendrogram linkage. Serialize to GeoParquet: cells.parquet (geometry + all metrics + all classifications), dendrogram.json (linkage matrix). Then load GeoParquet in browser using DuckDB-WASM or parquet-wasm. Render cells as MapLibre fill-extrusion (colored by Spacematrix type). Test FPS at city scale.

**Phase 2: Classification Systems + Diagrams** â€” Implement classification toggle (top bar): Spacematrix | LCZ | Cluster. Switching recolors all cells from pre-computed classification columns. Implement Spacematrix scatter diagram (right panel, 400Ã—400px): Canvas 2D, X=GSI (0â€“1), Y=FSI (0â€“6), each dot = one cell colored by type. Draw type zone boundaries as labeled regions. Implement D3.js dendrogram (right panel, below diagram): Ward's hierarchical tree with leaf nodes = cluster types, colored by cluster ID. Click a cluster node â†’ highlight all cells of that cluster on map. Implement cell hover tooltip.

**Phase 3: Linked Views + Polish** â€” Bidirectional linking: (1) brush selection on Spacematrix diagram â†’ highlight matching cells on map, (2) click a type zone label â†’ highlight all cells of that type, (3) click map cell â†’ highlight its dot in diagram and its cluster in dendrogram, (4) click dendrogram leaf â†’ highlight cluster on map. Implement level-of-detail zoom: z<15 shows flat colored polygons (MapLibre fill layer), zâ‰¥15 transitions to 3D buildings (InstancedMesh via Three.js) with cell colors as ground plane. Polish: add legend for each classification system, cell count per type, geographic coherence visualization.

### Stack

MapLibre GL JS ^5.0.0, Three.js ^0.178.0, @dvt3d/maplibre-three-plugin ^1.3.0, React ^19.0.0, TypeScript ^5.9.0, Vite ^7.0.0, Zustand ^5.0.0, D3.js ^7.9.0, DuckDB-WASM ^1.29.0 (or parquet-wasm).
Batch pipeline (Python): OSMnx ^2.1, momepy ^0.11, neatnet ^0.3, scikit-learn ^1.6, scipy, geopandas ^1.1, pyarrow.

### Three Classification Systems

**System 1 â€” Spacematrix (8 types):**
Types by FSI/GSI/L thresholds:
1. Low-rise low-density (Lâ‰¤2, GSI<0.2)
2. Low-rise medium-density (Lâ‰¤2, 0.2â‰¤GSI<0.4)
3. Low-rise high-density (Lâ‰¤2, GSIâ‰¥0.4)
4. Mid-rise low-density (2<Lâ‰¤5, GSI<0.3)
5. Mid-rise medium-density (2<Lâ‰¤5, 0.3â‰¤GSI<0.5)
6. Mid-rise high-density (2<Lâ‰¤5, GSIâ‰¥0.5)
7. High-rise low-density (L>5, GSI<0.3)
8. High-rise high-density (L>5, GSIâ‰¥0.3)
Colors: light greens â†’ yellows â†’ oranges â†’ reds

**System 2 â€” Local Climate Zone (10 classes):**
Based on BSF, BH, SVF proxy, H/W, PSF proxy:
1. Compact high-rise (#d32f2f)
2. Compact midrise (#e64a19)
3. Compact low-rise (#f57c00)
4. Open high-rise (#7b1fa2)
5. Open midrise (#512da8)
6. Open low-rise (#303f9f)
7. Lightweight low-rise (#0288d1)
8. Large low-rise (#00796b)
9. Sparsely built (#689f38)
10. Heavy industry (#757575)

**System 3 â€” Morphometric Clustering:**
Features: 74 primary metrics â†’ PCA (90% variance, ~15â€“20 components) â†’ GMM (BIC selects k â‰ˆ 8â€“12)
Ward's linkage for dendrogram hierarchy
Colors: D3 categorical palette (schemeCategory10 or similar)

### UI Layout

- **Map** fills left portion of viewport (â‰ˆ70%)
- **Classification toggle** (top bar): Spacematrix | LCZ | Cluster
- **Right panel** (30%, scrollable):
  - Spacematrix diagram (400Ã—400 Canvas)
  - Dendrogram (D3 tree, 400Ã—300)
  - Legend for current classification
  - Cell count per type
- **Cell hover tooltip**: FSI, GSI, L, Spacematrix type, LCZ class, cluster ID
- **Zoom LOD indicator** (bottom): "Zoom in to see 3D buildings"

### Research Context

Key planning documents in the research/ directory:
- research/88-plan-p5-taxonomy.md â€” complete implementation plan
- research/findings-11-academic-urban-typology.md â€” typology frameworks
- research/findings-12-computational-classification.md â€” classification methods
- research/findings-13-user-defined-taxonomy.md â€” taxonomy systems

### Critical Notes

- The batch pipeline runs ONCE to generate data files. Store output in prototypes/p5-taxonomy/data/ (gitignored if >50MB, otherwise committed)
- For the batch pipeline, create a Python script: prototypes/p5-taxonomy/scripts/extract_sf.py
- DuckDB-WASM can read GeoParquet directly in the browser â€” use spatial extension for geometry parsing
- Alternative to DuckDB-WASM: use parquet-wasm + manual WKB parsing (simpler but more code)
- Spacematrix diagram MUST use Canvas 2D for 30K dots â€” SVG would be too slow
- D3 dendrogram: use d3.hierarchy() + d3.tree() layout
- MapLibre fill-extrusion for cells: use `fill-extrusion-color` data-driven property with classification column
- For LOD transition at zâ‰¥15: listen to map zoom events, conditionally show Three.js building layer
- San Francisco bbox approximately: [-122.52, 37.71, -122.36, 37.81]
- UTM zone for SF: 10N (EPSG:32610)
- Expected cell count: 30Kâ€“50K tessellation cells from ~80K buildings
