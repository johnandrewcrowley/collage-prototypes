You are building prototype P2 (Morpho-Metrics Scanner) for the Collage Earth project.

## Your Assignment

You are working on prototype P2 in the directory prototypes/p2-morphology/.
P2 validates the workflow: select area (max 1 km¬≤) ‚Üí extract buildings and streets ‚Üí compute ~51 morphometric metrics across 6 categories ‚Üí visualize per-building and per-cell metric values with instant choropleth switching ‚Üí display statistical distributions and Spacematrix classification.

## Rules (critical)

1. ONLY modify files in prototypes/p2-morphology/. Never modify shared code, other prototypes, or root config.
2. FINDINGS.md is your primary output. Update it continuously as you work.
3. Commit frequently: proto(p2): description
4. Log all measurements (times, memory, FPS, success/failure rates) in FINDINGS.md.
5. If you observe any early failure indicator, stop, document it, and write your findings.
6. This is a prototype ‚Äî prioritize working features over polish. Skip extensive error handling.
7. Import shared components: `import { MapShell, useMapStore, BuildingMeshManager, colorize, COLOR_RAMPS, extractArea } from '@collage/map-template';`
8. Import types: `import type { ... } from '@collage/proto-types';`
9. The Python backend runs at http://localhost:8000. The Vite proxy maps /api/* to the backend.

## Session Workflow

1. Check git log for prior work on this prototype
2. Read prototypes/p2-morphology/FINDINGS.md for current state
3. Continue from where you left off (or start Phase 1 if fresh)
4. Work through the phases in order (see brief below)
5. Update FINDINGS.md after each phase
6. At the end of each phase, write a **Manual Testing** checkpoint in FINDINGS.md (see below)
7. Commit and push when done or when stopping
8. When all phases are complete, change FINDINGS.md status to "Status: Complete"

## Manual Testing Checkpoints (critical)

The project owner is an architect, not a developer. After each phase:

1. **Commit your work** so the owner can test at any time.
2. **Add a "Manual Testing" section** under each phase in FINDINGS.md with:
   - Step-by-step instructions (assume no command-line knowledge)
   - What to look for and what "good" vs "bad" looks like
3. **Mark each checkpoint** with one of:
   - `üîç Awaiting human verification` ‚Äî owner hasn't tested yet
   - `‚úÖ Human-verified` ‚Äî owner confirmed it works
   - `‚ö†Ô∏è Human-verified with issues` ‚Äî owner found problems
4. **Do NOT wait for testing.** Continue to the next phase immediately.

## Prototype Brief

### Question
Can the full momepy morphometric catalog (~51 metrics) be computed and visualized from OSM data in a web app, with instant building recoloring and distribution charts?

### Success Criteria

1. All 51 metrics compute without errors on Barcelona Eixample dataset
2. Tier 1 metrics (36 metrics, main thread): <200ms total computation
3. Tier 2 metrics (9 metrics, Web Worker): <5s total computation
4. Building color switching between any two metrics: <200ms (feels instant)
5. Barcelona Eixample validation: GSI ‚âà 0.37, FSI ‚âà 1.89 (¬±15%)
6. Spacematrix card correctly shows type (expected: "Compact Midrise")
7. Histogram reflects actual metric distribution (20 bins, correct shape)
8. Building hover tooltip shows top metrics
9. Tessellation view shows per-cell coloring correctly
10. Pin-and-compare works for 2 different areas
11. Multi-city test: Barcelona, Prague, and Phoenix all produce plausible metrics
12. Color ramp legend updates correctly when switching metrics

### Failure Indicators (stop early)

- Tier 1 metrics take >2s on main thread (blocks UI)
- Turf.js fails on degenerate polygon geometries
- Building recoloring causes visible flicker or >500ms delay

### Phases

**Phase 1: Metric Computation Engine** ‚Äî Implement all Tier 1 (36 TS main thread) and Tier 2 (9 TS Web Worker) metrics. Use Turf.js for area/distance/convex hull, Flatbush for spatial indexing (adjacency, neighbor count, street alignment), Graphology for betweenness centrality. Request Tier 3 metrics (6) from backend (/metrics/momepy returns tessellation, shared walls, Simpson diversity, etc.). Organize metrics into 6 categories. Store computed values in a Map<buildingId, Record<metricKey, number>>. Validate against known Barcelona values.

**Phase 2: Metric Visualization** ‚Äî Implement metric browser sidebar with 6 collapsible category groups. Clicking a metric recolors all buildings instantly using BuildingMeshManager + colorize(). Add tessellation cell rendering (MapLibre fill-extrusion layer from backend tessellation data) for per-cell metrics. Implement building/tessellation view toggle. Add color ramp legend (bottom-right) that updates with each metric. Implement Spacematrix summary card showing FSI, GSI, OSR, L values and classified type. Add building hover tooltip showing top 8 metric values.

**Phase 3: Statistics and Comparison** ‚Äî Implement histogram panel (SVG, 20 bins) showing distribution of currently selected metric. Include mean, median, std dev, min/max in stats row. Implement pin-and-compare: user can save a snapshot of current area metrics and compare side-by-side with another area in a table. Highlight the currently hovered building in the histogram. Test with 3 different cities (Barcelona, Prague, Phoenix) to validate metric ranges and visual correctness.

### Stack

MapLibre GL JS ^5.0.0, Three.js ^0.178.0, @dvt3d/maplibre-three-plugin ^1.3.0, React ^19.0.0, TypeScript ^5.9.0, Vite ^7.0.0, Zustand ^5.0.0, @turf/turf ^7.0.0, Flatbush ^4.4.0, Graphology ^0.25.0.

### 51 Metrics by Category

**Dimension (8):** building area, floor area, perimeter, height, volume, longest axis, courtyard area, coverage ratio
**Shape (14):** elongation, circular compactness, convexity, rectangularity, squareness, courtyard index, ERI, facade ratio, fractal dimension, shape index, square compactness, form factor, corners, centroid-corner distance
**Spatial Distribution (9):** orientation, orientation consistency, street alignment, inter-building distance (mean), inter-building distance (min), adjacency ratio, neighbor count, shared walls, cell alignment
**Intensity/Spacematrix (8):** FSI, GSI, OSR, L, network density, dwelling units, population, land use mix
**Diversity (5):** height Gini, height std dev, height CV, Simpson diversity, Theil inequality
**Streetscape (7):** intersection density, link-node ratio, meshedness, 4-way proportion, canyon H/W, street setback, betweenness centrality

### Computation Tiers

- **Tier 1 (36 metrics, TS main thread, <200ms):** All Dimension D1‚ÄìD7, all Shape S1‚ÄìS14, Orientation SD1‚ÄìSD2, all Intensity I1‚ÄìI8, Streetscape N1‚ÄìN5
- **Tier 2 (9 metrics, TS Web Worker, <5s):** Street alignment SD3, inter-building distance SD4‚ÄìSD5, adjacency ratio SD6, neighbor count SD7, height Gini Dv1, height std/CV Dv2‚ÄìDv3, betweenness N7
- **Tier 3 (6 metrics, Python backend):** Coverage ratio D8, shared walls SD8, cell alignment SD9, Simpson diversity Dv4, Theil inequality Dv5, street setback N6

### UI Layout

- **Map** fills viewport with 3D buildings
- **Metric browser sidebar** (left, 280px): 6 collapsible categories, click metric to recolor
- **Building/Tessellation toggle** (top of sidebar): switch between building and cell views
- **Spacematrix card** (top of sidebar): FSI, GSI, OSR, L values + type classification
- **Histogram panel** (bottom-left, collapsible): 20-bin SVG chart + stats row
- **Pin-and-compare** (bottom, expandable): side-by-side metric comparison table
- **Color ramp legend** (bottom-right): vertical gradient with metric name, min/max values
- **Building hover tooltip**: building ID + top 8 metric values

### Research Context

Key planning documents in the research/ directory:
- research/85-plan-p2-morphology.md ‚Äî complete implementation plan with code snippets and all 51 metric definitions
- research/findings-04-momepy-catalog.md ‚Äî momepy metric catalog
- research/findings-07-analysis-inputs.md ‚Äî input requirements mapping

### Critical Notes

- Flatbush spatial index must be rebuilt when switching between areas
- For adjacency: use 0.5m buffer threshold for shared wall detection in TS (approximate)
- Spacematrix type classification: use FSI/GSI/L threshold lookup table
- For Graphology betweenness: build graph from street network GeoJSON, run Brandes BFS
- Use viridis ramp as default, rdylbu for diverging metrics, spectral for orientation
- Tessellation cells come from backend /tessellate endpoint ‚Äî request alongside /metrics/momepy
